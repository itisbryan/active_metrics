---
phase: 01-redis-scan-migration
plan: 05
type: execute
wave: 3
depends_on: ["01-01"]
files_modified:
  - lib/rails_performance/gems/grape_ext.rb
autonomous: true

must_haves:
  truths:
    - "Grape API extension verified for SCAN compatibility"
    - "No direct KEYS usage found in Grape extension"
    - "Grape extension uses DataSource which uses updated utils.rb"
    - "All Grape key patterns work with SCAN"
    - "Grape queries maintain backwards compatibility"
  artifacts:
    - path: "lib/rails_performance/gems/grape_ext.rb"
      provides: "Grape API integration using DataSource"
      exports: ["RailsPerformance::Gems::GrapeExtension"]
  key_links:
    - from: "lib/rails_performance/gems/grape_ext.rb"
      to: "lib/rails_performance/data_source.rb"
      via: "RailsPerformance::DataSource"
      pattern: "RailsPerformance::DataSource"
    - from: "lib/rails_performance/data_source.rb"
      to: "lib/rails_performance/utils.rb"
      via: "Utils.fetch_from_redis"
      pattern: "Utils\.fetch_from_redis"
---

<objective>
Verify Grape API integration is compatible with SCAN implementation and works correctly with all Grape key patterns. Since Grape extension uses DataSource which calls Utils.fetch_from_redis, this plan ensures the integration is verified and documented as compatible.

Purpose: Confirm Grape API integration works seamlessly with SCAN migration without breaking existing functionality.

Output: Verification that Grape extension is SCAN-compatible, documentation of Grape query patterns tested.
</objective>

<execution_context>
@/Users/itisbryan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itisbryan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-redis-scan-migration/01-redis-scan-migration-CONTEXT.md
@.planning/phases/01-redis-scan-migration/01-redis-scan-migration-RESEARCH.md
@lib/rails_performance/gems/grape_ext.rb
@lib/rails_performance/data_source.rb
@lib/rails_performance/utils.rb
@.planning/phases/01-redis-scan-migration/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Verify Grape extension SCAN compatibility</name>
  <files>lib/rails_performance/gems/grape_ext.rb</files>
<action>
    Verify Grape extension is compatible with SCAN implementation:

    1. Read Grape extension to understand its structure:
       ```bash
       cat lib/rails_performance/gems/grape_ext.rb
       ```

    2. Check if Grape extension uses any direct Redis KEYS commands:
       ```bash
       grep -n "\.keys(" lib/rails_performance/gems/grape_ext.rb || echo "No .keys() calls found"
       ```

    3. Verify Grape extension uses DataSource (which uses Utils.fetch_from_redis):
       - Look for `RailsPerformance::DataSource` usage
       - Confirm no direct Redis client access

    4. If Grape extension uses DataSource, add compatibility comment:
       ```ruby
       # Grape API extension uses RailsPerformance::DataSource for queries
       # DataSource -> Utils.fetch_from_redis -> SCAN (when use_scan = true)
       # No changes needed for SCAN compatibility - uses updated utils.rb
       ```

    5. Create test verification in test/grape_scan_test.rb:
       ```ruby
       # frozen_string_literal: true

       require 'minitest/autorun'
       require 'redis'
       require_relative '../lib/rails_performance'
       require_relative '../lib/rails_performance/gems/grape_ext'
       require_relative '../lib/rails_performance/utils'

       class GrapeScanCompatibilityTest < Minitest::Test
         def setup
           @redis = Redis.new
           @test_key_prefix = "grape|test|scan|#{Time.now.to_i}|"
           @redis.keys("#{@test_key_prefix}*").each { |k| @redis.del(k) }
           RailsPerformance.redis = @redis
           RailsPerformance.use_scan = false  # Start with KEYS
         end

         def teardown
           @redis.keys("#{@test_key_prefix}*").each { |k| @redis.del(k) }
         end

         def create_grape_test_keys
           50.times do |i|
             key = "#{@test_key_prefix}datetime|20260204T#{i.to_s.rjust(4, '0')}|END|1.0.0"
             @redis.set(key, "{\"endpoint\": \"/api/test\", \"status\": 200}")
           end
         end

         def test_grape_query_pattern_with_keys
           create_grape_test_keys
           query = "grape|*datetime|20260204*|END|1.0.0"

           RailsPerformance.use_scan = false
           keys, values = RailsPerformance::Utils.fetch_from_redis(query)

           assert_equal 50, keys.size
           assert_equal keys, keys.sort, "KEYS returns sorted results"
         end

         def test_grape_query_pattern_with_scan
           create_grape_test_keys
           query = "grape|*datetime|20260204*|END|1.0.0"

           RailsPerformance.use_scan = true
           keys_scan, values_scan = RailsPerformance::Utils.fetch_from_redis(query)

           RailsPerformance.use_scan = false
           keys_keys, values_keys = RailsPerformance::Utils.fetch_from_redis(query)

           assert_equal 50, keys_scan.size
           assert_equal keys_scan.sort, keys_scan, "SCAN returns sorted results"
           assert_equal keys_scan.sort, keys_keys.sort, "SCAN and KEYS return same keys"
         end

         def test_grape_extension_uses_datasource
           # Verify Grape extension doesn't call Redis directly
           grape_ext_code = File.read('lib/rails_performance/gems/grape_ext.rb')

           refute_match(/redis\.keys\(/, grape_ext_code, "Grape extension should not call redis.keys directly")
           assert_match(/DataSource/, grape_ext_code, "Grape extension should use DataSource")
         end
       end
       ```

    Per research: Grape API integration tests pass across supported Grape versions.
    The key verification is that Grape uses DataSource (not direct Redis calls).
  </action>
  <verify>Run ruby -c lib/rails_performance/gems/grape_ext.rb, then grep -i "datasource" lib/rails_performance/gems/grape_ext.rb to confirm DataSource usage</verify>
  <done>Grape extension verified as SCAN-compatible, no direct Redis KEYS calls, uses DataSource</done>
</task>

<task type="auto">
  <name>Add Grape-specific SCAN tests</name>
  <files>test/grape_scan_test.rb</files>
  <action>
    Create Grape-specific integration tests:

    1. Create test/grape_scan_test.rb with Grape pattern tests:
       ```ruby
       # frozen_string_literal: true

       require 'minitest/autorun'
       require 'redis'
       require_relative '../lib/rails_performance'
       require_relative '../lib/rails_performance/utils'

       class GrapeScanTest < Minitest::Test
         def setup
           @redis = Redis.new
           @test_key_prefix = "grape|performance|test|#{Time.now.to_i}|"
           @redis.keys("#{@test_key_prefix}*").each { |k| @redis.del(k) }
           RailsPerformance.redis = @redis
         end

         def teardown
           @redis.keys("#{@test_key_prefix}*").each { |k| @redis.del(k) }
         end

         def create_grape_keys(count, endpoint: "/api/test", status: 200)
           count.times do |i|
             key = "#{@test_key_prefix}controller|#{endpoint}|status|#{status}|datetime|20260204T#{i.to_s.rjust(4, '0')}|END|1.0.0"
             @redis.set(key, "{\"endpoint\": \"#{endpoint}\", \"status\": #{status}}")
           end
         end

         def test_grape_status_filter_with_scan
           create_grape_keys(30, status: 200)
           create_grape_keys(10, status: 500)

           RailsPerformance.use_scan = true
           ds = RailsPerformance::DataSource.new(type: :grape, q: { on: Date.today, status: 200 })
           result = ds.add_to

           assert_equal 30, result.data.size
         end

         def test_grape_datetime_filter_with_scan
           create_grape_keys(50)

           RailsPerformance.use_scan = true
           ds = RailsPerformance::DataSource.new(type: :grape, q: { on: Date.today })
           result = ds.add_to

           assert_equal 50, result.data.size
         end

         def test_grape_scan_vs_keys_parity
           create_grape_keys(100)

           RailsPerformance.use_scan = true
           ds_scan = RailsPerformance::DataSource.new(type: :grape, q: { on: Date.today })
           result_scan = ds_scan.add_to

           RailsPerformance.use_scan = false
           ds_keys = RailsPerformance::DataSource.new(type: :grape, q: { on: Date.today })
           result_keys = ds_keys.add_to

           assert_equal result_keys.data.size, result_scan.data.size
           assert_equal result_keys.data.size, 100
         end
       end
       ```

    2. Run Grape-specific tests:
       ```bash
       rake test TEST=test/grape_scan_test.rb
       ```

    Per research: Verify Grape key patterns work with SCAN.
    Grape uses pattern: "grape|*datetime|YYYYMMDD*|END|{SCHEMA}"
  </action>
  <verify>Run ruby -c test/grape_scan_test.rb, then run tests and verify all Grape SCAN tests pass</verify>
  <done>Grape SCAN tests created and passing, all Grape query patterns work with SCAN</done>
</task>

</tasks>

<verification>
Overall phase checks:
1. lib/rails_performance/gems/grape_ext.rb read and analyzed
2. No direct redis.keys() calls in Grape extension
3. Grape extension uses RailsPerformance::DataSource
4. Compatibility comment added to grape_ext.rb
5. test/grape_scan_test.rb created with Grape-specific tests
6. Tests verify Grape status filter works with SCAN
7. Tests verify Grape datetime filter works with SCAN
8. Tests verify SCAN vs KEYS parity for Grape queries
9. All Grape tests pass with use_scan = true
10. Grape key patterns confirmed compatible with SCAN
</verification>

<success_criteria>
1. Grape extension verified as SCAN-compatible
2. No direct Redis KEYS usage in Grape extension
3. Grape extension uses DataSource (which uses Utils.fetch_from_redis)
4. Compatibility comment added to grape_ext.rb
5. test/grape_scan_test.rb created
6. Grape status filter test passes with SCAN
7. Grape datetime filter test passes with SCAN
8. SCAN vs KEYS parity test passes
9. All Grape tests pass
10. Grape key patterns documented as SCAN-compatible
</success_criteria>

<output>
After completion, create `.planning/phases/01-redis-scan-migration/01-05-SUMMARY.md` with:
- Grape extension compatibility verification results
- Grape query patterns tested
- Test results summary
- Any Grape-specific considerations
- Files modified/created
</output>
