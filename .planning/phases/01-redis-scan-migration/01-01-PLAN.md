---
phase: 01-redis-scan-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/rails_performance/utils.rb
  - lib/rails_performance.rb
autonomous: true

must_haves:
  truths:
    - "Feature flag use_scan defaults to false (KEYS behavior) for backwards compatibility"
    - "SCAN implementation uses redis-rb's scan_each method"
    - "SCAN results are sorted to match KEYS order for backwards compatibility"
    - "Deprecation warning emitted when KEYS path is used"
    - "Existing fetch_from_redis behavior unchanged when feature flag disabled"
  artifacts:
    - path: "lib/rails_performance.rb"
      provides: "use_scan and scan_count configuration options"
      contains: "mattr_accessor :use_scan"
      contains: "mattr_accessor :scan_count"
    - path: "lib/rails_performance/utils.rb"
      provides: "Non-blocking SCAN implementation with feature flag"
      contains: "fetch_with_scan"
      exports: ["fetch_from_redis"]
  key_links:
    - from: "lib/rails_performance/utils.rb"
      to: "RailsPerformance.redis"
      via: "redis.scan_each method"
      pattern: "scan_each\(match:.*count:"
    - from: "lib/rails_performance/utils.rb"
      to: "lib/rails_performance.rb"
      via: "RailsPerformance.use_scan configuration"
      pattern: "RailsPerformance\.use_scan"
---

<objective>
Implement the foundation for Redis SCAN migration by adding feature flag configuration and SCAN implementation in utils.rb. This plan creates the core infrastructure that enables gradual rollout from blocking KEYS to non-blocking SCAN, ensuring backwards compatibility through a feature flag that defaults to KEYS behavior.

Purpose: Replace production-blocking Redis KEYS command with non-blocking SCAN iteration while maintaining full backwards compatibility through feature flag control.

Output: Feature flag configuration (use_scan, scan_count) and SCAN implementation using scan_each method in utils.rb with deprecation warnings.
</objective>

<execution_context>
@/Users/itisbryan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itisbryan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-redis-scan-migration/01-redis-scan-migration-CONTEXT.md
@.planning/phases/01-redis-scan-migration/01-redis-scan-migration-RESEARCH.md
@lib/rails_performance/utils.rb
@lib/rails_performance.rb
@lib/rails_performance/data_source.rb
</context>

<tasks>

<task type="auto">
  <name>Add SCAN feature flag configuration to rails_performance.rb</name>
  <files>lib/rails_performance.rb</files>
  <action>
    Add feature flag configuration options to RailsPerformance module following existing mattr_accessor pattern:

    1. After line 101 (http_basic_authentication_password), add:
       ```ruby
       # Enable Redis SCAN for non-blocking key iteration (default: false for backwards compatibility)
       mattr_accessor :use_scan
       @@use_scan = false

       # SCAN COUNT parameter for performance tuning (default: 10, Redis default)
       mattr_accessor :scan_count
       @@scan_count = 10

       # Enable automatic SCAN COUNT tuning based on query type (default: true)
       mattr_accessor :scan_count_auto_tune
       @@scan_count_auto_tune = true
       ```

    2. Follow existing code style:
       - Use frozen_string_literal: true (already at top)
       - Use mattr_accessor following existing pattern
       - Default use_scan to false (KEYS behavior) for backwards compatibility
       - Default scan_count to 10 (Redis default COUNT value)
       - Default scan_count_auto_tune to true for automatic optimization

    Per user decision: Feature flag must default to false (KEYS) to avoid immediate production impact.
  </action>
  <verify>Run `grep -A 5 "mattr_accessor :use_scan" lib/rails_performance.rb` and verify three new accessors exist with correct defaults</verify>
  <done>Three new configuration options exist: use_scan (false), scan_count (10), scan_count_auto_tune (true)</done>
</task>

<task type="auto">
  <name>Implement SCAN with fetch_with_scan method in utils.rb</name>
  <files>lib/rails_performance/utils.rb</files>
  <action>
    Add SCAN implementation following redis-rb scan_each pattern from research:

    1. After fetch_from_redis method (after line 41), add new methods:
       ```ruby
       def self.fetch_with_scan(query)
         count = determine_scan_count(query)

         keys = RailsPerformance.redis.scan_each(
           match: query,
           count: count
         ).to_a.sort

         keys
       end

       def self.determine_scan_count(query)
         return RailsPerformance.scan_count unless RailsPerformance.scan_count_auto_tune

         # Auto-tune based on query type per research recommendations
         case query
         when /datetime|\d{8}/  # Date-scoped query (e.g., datetime|20260204*)
           1000  # Larger COUNT for date ranges
         when /request_id/      # Specific request lookup
           10   # Smaller COUNT for specific lookups
         else                   # Broad queries (controller, action, status, etc.)
           100  # Medium COUNT for general queries
         end
       end
       ```

    2. Modify fetch_from_redis (lines 30-41) to use feature flag:
       ```ruby
       def self.fetch_from_redis(query)
         RailsPerformance.log "\n\n   [REDIS QUERY]   -->   #{query}\n\n"

         if RailsPerformance.use_scan
           keys = fetch_with_scan(query)
         else
           RailsPerformance.log "   [DEPRECATION] Using KEYS command. Set RailsPerformance.use_scan = true to use non-blocking SCAN.\n"
           keys = RailsPerformance.redis.keys(query)
         end

         return [] if keys.blank?

         values = RailsPerformance.redis.mget(keys)

         RailsPerformance.log "\n\n   [FOUND]   -->   #{values.size}\n\n"

         [keys, values]
       end
       ```

    Key implementation details per research:
    - Use scan_each (not manual scan loop) for Ruby-idiomatic code
    - Sort results to match KEYS order (backwards compatibility requirement)
    - Auto-tune COUNT: 1000 for date-scoped, 10 for specific, 100 for broad queries
    - Add deprecation warning when KEYS path is used
  </action>
  <verify>Run ruby -c lib/rails_performance/utils.rb to check syntax, then grep -n "fetch_with_scan\|determine_scan_count" lib/rails_performance/utils.rb to verify methods exist</verify>
  <done>fetch_with_scan and determine_scan_count methods exist, fetch_from_redis uses feature flag with deprecation warning</done>
</task>

</tasks>

<verification>
Overall phase checks:
1. Feature flag defaults to false (KEYS behavior) - grep "mattr_accessor :use_scan" and verify @@use_scan = false
2. SCAN uses scan_each method - grep "scan_each" in utils.rb
3. SCAN results are sorted - grep "\.sort" in fetch_with_scan method
4. Deprecation warning present - grep "DEPRECATION" in fetch_from_redis method
5. Code follows existing patterns - uses mattr_accessor, follows naming conventions
</verification>

<success_criteria>
1. Feature flag use_scan defaults to false (KEYS behavior) for backwards compatibility
2. scan_count configuration option available with default value 10
3. scan_count_auto_tune configuration option available with default value true
4. fetch_with_scan method uses redis.scan_each with configurable COUNT
5. fetch_with_scan sorts results to match KEYS order
6. determine_scan_count auto-tunes COUNT based on query type (date-scoped: 1000, specific: 10, broad: 100)
7. fetch_from_redis checks use_scan flag and calls fetch_with_scan when true
8. fetch_from_redis emits deprecation warning when using KEYS path
9. All code follows existing code style and conventions
10. Ruby syntax check passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-redis-scan-migration/01-01-SUMMARY.md` with:
- What was implemented (feature flags, SCAN methods)
- Decisions made (COUNT tuning values, deprecation warning placement)
- Files modified
- Verification results
- Any deviations from plan
</output>
