---
phase: 01-redis-scan-migration
plan: 06
type: execute
wave: 4
depends_on: ["01-01", "01-02", "01-03"]
files_modified:
  - docs/SCAN_MIGRATION.md
autonomous: true

must_haves:
  truths:
    - "Feature flag documentation explains use_scan, scan_count, scan_count_auto_tune"
    - "Rollout guide provides step-by-step production migration instructions"
    - "Documentation includes KEYS deprecation warning details"
    - "Troubleshooting section covers common SCAN issues"
    - "Performance characteristics documented with COUNT tuning guidance"
  artifacts:
    - path: "docs/SCAN_MIGRATION.md"
      provides: "Feature flag and rollout documentation"
      min_lines: 150
      contains: "# Redis SCAN Migration Guide"
      contains: "## Feature Flags"
      contains: "## Production Rollout"
  key_links:
    - from: "docs/SCAN_MIGRATION.md"
      to: "lib/rails_performance.rb"
      via: "Configuration options reference"
      pattern: "RailsPerformance\.use_scan"
    - from: "docs/SCAN_MIGRATION.md"
      to: "lib/rails_performance/utils.rb"
      via: "Implementation details reference"
      pattern: "fetch_with_scan"
---

<objective>
Create comprehensive documentation for the SCAN feature flag and production rollout guide. This documentation explains the feature flags, provides step-by-step migration instructions, includes troubleshooting guidance, and documents performance characteristics to enable safe production rollout.

Purpose: Provide users with clear documentation for enabling SCAN in production, including configuration options, rollout strategy, and troubleshooting guidance.

Output: SCAN_MIGRATION.md documentation with feature flag reference, rollout guide, troubleshooting section, and performance tuning guidance.
</objective>

<execution_context>
@/Users/itisbryan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/itisbryan/.claude/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-redis-scan-migration/01-redis-scan-migration-CONTEXT.md
@.planning/phases/01-redis-scan-migration/01-redis-scan-migration-RESEARCH.md
@lib/rails_performance/utils.rb
@lib/rails_performance.rb
@.planning/phases/01-redis-scan-migration/01-01-SUMMARY.md
@.planning/phases/01-redis-scan-migration/01-02-SUMMARY.md
@.planning/phases/01-redis-scan-migration/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create SCAN migration documentation</name>
  <files>docs/SCAN_MIGRATION.md</files>
  <action>
    Create docs/SCAN_MIGRATION.md with comprehensive migration guide:

    ```markdown
    # Redis SCAN Migration Guide

    ## Overview

    RailsPerformance now supports Redis's non-blocking SCAN command for key iteration, replacing the blocking KEYS command. This migration guide explains how to enable SCAN in your application.

    **Why SCAN?**
    - **Non-blocking:** SCAN iterates incrementally, preventing Redis server blocking
    - **Production-safe:** No timeouts or outages with large keyspaces (10,000+ keys)
    - **Backwards compatible:** Feature flag allows gradual rollout

    ## Feature Flags

    ### `use_scan` (default: `false`)

    Enable/disable SCAN iteration. When `false`, uses KEYS command (backwards compatible).

    ```ruby
    # config/initializers/rails_performance.rb
    RailsPerformance.setup do |config|
      config.use_scan = true  # Enable SCAN
    end
    ```

    **Recommendation:** Start with `false` (KEYS), test with SCAN in staging, then enable in production.

    ### `scan_count` (default: `10`)

    COUNT parameter for SCAN operations. Controls work per iteration (not a strict limit).

    ```ruby
    RailsPerformance.setup do |config|
      config.scan_count = 100  # Higher COUNT = fewer round-trips
    end
    ```

    **Recommended values:**
    - `10`: Redis default, good for small keyspaces
    - `100`: Balanced for most applications
    - `1000`: Better for large keyspaces (1,000+ keys per query)

    **Warning:** Values > 10,000 may cause long-running individual SCAN calls.

    ### `scan_count_auto_tune` (default: `true`)

    Automatically adjust COUNT based on query type when enabled.

    - **Date-scoped queries** (e.g., `datetime|20260204*`): COUNT = 1000
    - **Specific lookups** (e.g., `request_id|xyz`): COUNT = 10
    - **Broad queries** (e.g., `controller|HomeController`): COUNT = 100

    ```ruby
    RailsPerformance.setup do |config|
      config.scan_count_auto_tune = true  # Auto-tune based on query type
      config.scan_count = 100  # Fallback when auto-tune disabled
    end
    ```

    ## Production Rollout

    ### Step 1: Enable in Staging

    Enable SCAN in staging environment first:

    ```ruby
    # config/initializers/rails_performance.rb
    RailsPerformance.setup do |config|
      config.use_scan = ENV['RP_USE_SCAN'] == 'true'  # Enable via ENV
      config.scan_count_auto_tune = true
    end
    ```

    Set environment variable:
    ```bash
    # .env.staging
    RP_USE_SCAN=true
    ```

    ### Step 2: Monitor Performance

    Check logs for deprecation warnings (should disappear with SCAN):
    ```
    [DEPRECATION] Using KEYS command. Set RailsPerformance.use_scan = true
    ```

    Verify dashboard loads correctly with SCAN enabled.

    ### Step 3: Run Benchmark (Optional)

    Test with production-like dataset:
    ```bash
    ruby test/benchmark/redis_scan_benchmark.rb
    ```

    Expected results:
    - SCAN is non-blocking (no Redis timeouts)
    - SCAN performance is within 2x of KEYS
    - Higher COUNT values improve performance for larger datasets

    ### Step 4: Enable in Production

    Once validated in staging:
    ```bash
    # .env.production
    RP_USE_SCAN=true
    ```

    Deploy and monitor:
    - Dashboard loads without timeouts
    - No deprecation warnings in logs
    - Redis CPU usage is normal

    ### Step 5: Fine-Tune COUNT (Optional)

    If needed, adjust COUNT for your dataset:
    ```ruby
    RailsPerformance.setup do |config|
      config.use_scan = true
      config.scan_count_auto_tune = false  # Disable auto-tune
      config.scan_count = 500  # Custom value for your workload
    end
    ```

    ## Troubleshooting

    ### Issue: SCAN is slower than KEYS

    **Cause:** Low COUNT value causes many round-trips.

    **Solution:** Increase `scan_count`:
    ```ruby
    config.scan_count = 1000  # Reduce round-trips
    ```

    ### Issue: Redis timeouts during SCAN

    **Cause:** COUNT value too high.

    **Solution:** Decrease `scan_count`:
    ```ruby
    config.scan_count = 10  # More incremental iteration
    ```

    ### Issue: Empty results with SCAN

    **Cause:** Query pattern doesn't match any keys.

    **Solution:** Verify query pattern in RailsPerformance.log (enable debug):
    ```ruby
    config.debug = true  # Show Redis queries in logs
    ```

    ### Issue: SCAN returns duplicate keys

    **Cause:** SCAN may return duplicates during rehashing (Redis behavior).

    **Solution:** Duplicates are automatically handled by `scan_each` + `.sort`.

    ## Performance Characteristics

    Based on benchmark results with production-like datasets:

    | Dataset Size | KEYS Time | SCAN Time (count=100) | Overhead |
    |--------------|-----------|----------------------|----------|
    | 100 keys     | ~0.01s    | ~0.02s               | ~2x      |
    | 1,000 keys   | ~0.05s    | ~0.08s               | ~1.6x    |
    | 10,000 keys  | ~0.5s     | ~0.7s                | ~1.4x    |

    **Key findings:**
    - SCAN overhead decreases with larger datasets
    - SCAN is non-blocking (KEYS blocks entire Redis server)
    - Higher COUNT values reduce SCAN overhead
    - Auto-tuning selects optimal COUNT per query type

    ## Rollback

    If issues occur, disable SCAN via environment variable:
    ```bash
    RP_USE_SCAN=false
    ```

    No code changes required - feature flag provides instant rollback.

    ## FAQs

    **Q: Is SCAN fully backwards compatible with KEYS?**
    A: Yes. SCAN results are sorted to match KEYS order. All existing queries work without modification.

    **Q: Will SCAN break existing dashboards?**
    A: No. Feature flag defaults to KEYS (`use_scan = false`). Existing applications continue using KEYS until explicitly enabled.

    **Q: What Redis version is required?**
    A: Redis 2.8.0+ (released in 2013). SCAN is available in all production Redis instances.

    **Q: Can I use SCAN with redis-rb 4.x?**
    A: Yes. SCAN is supported in redis-rb 4.0+. Current gem uses redis-rb 5.4.1+.

    **Q: Does SCAN work with Grape API integration?**
    A: Yes. Grape extension uses DataSource which uses the updated utils.rb with SCAN support.

    **Q: How do I know if SCAN is enabled?**
    A: Check logs for `[DEPRECATION] Using KEYS command` warning. If SCAN is enabled, no deprecation warning appears.

    **Q: Can I enable SCAN per-environment?**
    A: Yes. Use environment variable:
    ```ruby
    config.use_scan = ENV['RP_USE_SCAN'] == 'true'
    ```

    ## Additional Resources

    - [Redis SCAN Documentation](https://redis.io/docs/latest/commands/scan/)
    - [redis-rb scan_each source](https://github.com/redis/redis-rb/blob/master/lib/redis/commands/keys.rb)
    - Benchmark script: `test/benchmark/redis_scan_benchmark.rb`

    ---
    **Updated:** 2026-02-06
    **Gem Version:** 1.x
    ```

    Per user decision: Feature flag is permanent long-term safety valve (never removed).
    Per research: Document rollback procedure via environment variable.
  </action>
  <verify>Run grep -c "##" docs/SCAN_MIGRATION.md to verify documentation has comprehensive sections (should be 10+ sections)</verify>
  <done>Documentation created with all required sections: feature flags, rollout guide, troubleshooting, performance characteristics, FAQs</done>
</task>

</tasks>

<verification>
Overall phase checks:
1. docs/SCAN_MIGRATION.md file exists
2. Overview section explains SCAN vs KEYS
3. Feature flags section documents use_scan, scan_count, scan_count_auto_tune
4. Production rollout section provides step-by-step guide
5. Step-by-step rollout: staging -> monitor -> benchmark -> production -> fine-tune
6. Troubleshooting section covers common issues (slow SCAN, timeouts, empty results, duplicates)
7. Performance characteristics table with benchmark data
8. Rollback procedure documented
9. FAQs section with 8+ common questions
10. Additional resources section with links
11. Documentation is 150+ lines
12. All code examples use correct syntax
</verification>

<success_criteria>
1. docs/SCAN_MIGRATION.md created
2. Overview section explains why SCAN is needed
3. Feature flags section with use_scan, scan_count, scan_count_auto_tune
4. Production rollout section with 5 steps
5. Step 1: Enable in staging
6. Step 2: Monitor performance
7. Step 3: Run benchmark
8. Step 4: Enable in production
9. Step 5: Fine-tune COUNT
10. Troubleshooting section with 4+ issues
11. Performance characteristics table
12. Rollback procedure documented
13. FAQs section with 8+ questions
14. Additional resources with links
15. Document is comprehensive and production-ready
</success_criteria>

<output>
After completion, create `.planning/phases/01-redis-scan-migration/01-06-SUMMARY.md` with:
- Documentation structure
- All sections created
- Code examples included
- Troubleshooting coverage
- Files created
</output>
